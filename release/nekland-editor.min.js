/*! nekland-editor 20-09-2013 */
void 0===window.nekland&&(window.nekland={}),void 0===window.nekland.lang&&(window.nekland.lang={}),window.nekland.lang.editor={},window.nekland.Editor=function(a,b,c){void 0!==b&&(b={}),void 0!==c&&(c={}),this.settings=$.extend(!0,{},{mode:"classical",uid:uniqid(),lang:"en"},b),this.translator=this.getTranslator(this.settings.lang),this.initModules(),this.templates=$.extend(!0,{},c,this.getTemplates()),this.$wrapper=this.templates.load(a,this.settings.uid),this.$domElement=a,this.$editor=this.$wrapper.find(".nekland-editor-html"),this.$editor=this.$editor.html(this.pize(this.$editor.html())),this.lastKey=null,this.addEvents()},window.nekland.Editor.prototype.switchEditor=function(a){return this.$editor.is(":visible")?(this.$editor.hide(),this.$domElement.val(this.clearHtml(this.$domElement.val())),this.$domElement.show(),a.html(this.translator.translate("swapToText",{ucfirst:!0}))):(this.$editor.html(this.clearHtml(this.pize(this.$domElement.val()))),this.$domElement.hide(),this.$editor.show(),a.html(this.translator.translate("swapToHtml",{ucfirst:!0}))),!1},window.nekland.Editor.prototype.synchronize=function(){return this.$domElement.val(this.$editor.html())},window.nekland.Editor.prototype.execute=function(a){var b,c,d,e=a.data("editor-module");for(b=0,c=this.modules.length;c>b;b++)this.modules[b].getName()===e&&this.$editor.is(":visible")&&(d=$.proxy(this.modules[b].execute,this,a)());return this.synchronize(),void 0!==d?d:!1},window.nekland.Editor.prototype.getTemplates=function(){var a=this;return{main:function(a){return'<div class="nekland-editor-html form-control" style="width:'+a[0]+"px;height:"+a[1]+'px" contenteditable="true"></div>'},switchButton:function(a){return void 0===a&&(a="nekland-switch-button"),'<a href="#" class="'+a+'"></a>'},before:function(b){var c,d,e;for(c="<div>",d=0,e=a.modules.length;e>d;d++)c+=a.modules[d].getTemplateBefore();return c+="</div>",c+=this.main(b)},after:function(){var b,c,d=this.switchButton();for(b=0,c=a.modules.length;c>b;b++)d+=a.modules[b].getTemplateAfter();return d},load:function(b,c){var d,e;return d=$("<div>",{id:"nekland-editor-wrapper-"+c}),b.wrap(d),b.before(this.before([b.width(),b.height()])),b.after(this.after()),b.css("display","block").hide(),d=$("#nekland-editor-wrapper-"+c),e=$.trim(b.val()),""!==e?d.find(".nekland-editor-html").html(e):d.find(".nekland-editor-html").html("<p></p>"),d.find(".nekland-switch-button").html(a.translator.translate("swapToHtml",{ucfirst:!0})),d}}},window.nekland.Editor.modules=[],window.nekland.Editor.prototype.initModules=function(){var a,b,c;for(this.modules=[],a=0,b=window.nekland.Editor.modules.length;b>a;a++)c=new window.nekland.Editor.modules[a](this.translator),this.checkModule(c),this.modules.push(c)},window.nekland.Editor.prototype.checkModule=function(a){if("function"!=typeof a.getTemplateBefore||"function"!=typeof a.getTemplateAfter||"function"!=typeof a.addEvents||"function"!=typeof a.getName||"function"!=typeof a.execute){var b=a.getName?a.getName():"not known name";throw"A module does't work. Check if the following module implements all needed methods: \""+b+'"'}return!0},window.nekland.Editor.prototype.addEvents=function(){var a,b=this;a=this.$wrapper.find(".nekland-switch-button"),a.click($.proxy(this.switchEditor,this,a)),this.$wrapper.find(".nekland-editor-command").click(function(){return b.execute($(this))}),this.$editor.keyup($.proxy(this.onKeyUp,this)),this.addModulesEvents()},window.nekland.Editor.prototype.addModulesEvents=function(){var a,b;for(a=0,b=this.modules.length;b>a;a++)$.proxy(this.modules[a].addEvents,this)()},window.nekland.Editor.prototype.onKeyUp=function(){this.synchronize()},window.nekland.Editor.prototype.removeEnter=function(a){return 13===a.which?a.preventDefault():void 0},window.nekland.Editor.prototype.getSelection=function(){return null!==window.getSelection?window.getSelection():null!==document.getSelection?document.getSelection():document.selection.createRange()},window.nekland.Editor.prototype.setSelection=function(a,b,c,d){var e,f;if(null===c&&(c=a),null===d&&(d=b),f=this.getSelection()){if(f.collapse&&f.extend)return f.collapse(a,b),f.extend(c,d);e=document.createRange(),e.setStart(a,b),e.setEnd(c,d);try{f.removeAllRanges()}catch(g){}return f.addRange(e)}},window.nekland.Editor.prototype.getCurrentNode=function(){return null!==window.getSelection?this.getSelectedNode().parentNode:void 0},window.nekland.Editor.prototype.getParentNode=function(){return $(this.getCurrentNode()).parent()[0]},window.nekland.Editor.prototype.getSelectedNode=function(){var a;return null!==window.getSelection?(a=window.getSelection(),a.rangeCount>0?this.getSelection().getRangeAt(0).commonAncestorContainer:!1):null!==document.selection?this.getSelection():void 0},window.nekland.Editor.prototype.setFocusNode=function(a){var b,c;return b=document.createRange(),c=this.getSelection(),null!==c&&(c.collapse(a,0),c.extend(a,0)),this.$editor.trigger("focus")},window.nekland.Editor.prototype.insertNodeAtCaret=function(a){var b,c;return c=this.getSelection,window.getSelection&&c.rangeCount?(b=c.getRangeAt(0),b.collapse(!1),b.insertNode(a),b=b.cloneRange(),b.selectNodeContents(a),b.collapse(!1),c.removeAllRanges(),c.addRange(b)):void 0},window.nekland.Editor.prototype.replaceSelection=function(){return null!==this.savedSel&&null!==this.savedSelObj&&"BODY"!==this.savedSel[0].tagName?0===$(this.savedSel[0]).closest(".nekland-editor-html").size()?this.$editor.focus():this.setSelection(this.savedSel[0],this.savedSel[1],this.savedSelObj[0],this.savedSelObj[1]):this.$editor.focus()},window.nekland.Editor.prototype.getOrigin=function(){var a;return(a=this.getSelection())&&null!==a.anchorNode?[a.anchorNode,a.anchorOffset]:null},window.nekland.Editor.prototype.getFocus=function(){var a;return(a=this.getSelection())&&null!==a.focusNode?[a.focusNode,a.focusOffset]:null},window.nekland.Editor.prototype.saveSelection=function(){this.$editor.focus(),this.savedSel=this.getOrigin(),this.savedSelObj=this.getFocus()},window.nekland.Editor.prototype.getTranslator=function(a){var b=function(a){this.translations=window.nekland.lang.editor[a]};return b.prototype.translate=function(a,b){var c;if(void 0===b&&(b={}),void 0===this.translations[a])throw new Error("Translation missing");return c=this.translations[a],void 0!==b.ucfirst&&(c=c.charAt(0).toUpperCase()+c.slice(1)),c},new b(a)},window.nekland.Editor.prototype.pize=function(a){return a=$.trim(a),""===a||"<p></p>"===a?"<p><br /></p>":a},window.nekland.Editor.prototype.clearHtml=function(a){return a.replace(/&nbsp;/g," ",a)},function(a){a.fn.neklandEditor=function(b,c){return this.each(function(){var d,e;return d=a(this),e=d.data("nekland-editor"),e?void 0:d.data("nekland-editor",new window.nekland.Editor(d,b,c))}),this}}(jQuery),window.nekland.lang.editor.en={swapToText:"swap to text",swapToHtml:"swap to html",italic:"italic",bold:"bold",addLink:"add link",close:"close",insertLink:"insert link",link:"link",removeLink:"remove link",notALink:"your link is not a valid link",modules:{}},function(){var a=function(a){this.translator=a};a.prototype.getTemplateBefore=function(){var a;return a='<div class="btn-group">',a+='<button type="button" class="btn btn-default nekland-editor-command" data-editor-module="basic" data-editor-command="bold"><b>'+this.translator.translate("bold",{ucfirst:!0})+"</b></button>",a+='<button type="button" class="btn btn-default nekland-editor-command" data-editor-module="basic" data-editor-command="italic"><i>'+this.translator.translate("italic",{ucfirst:!0})+"</i></button>",a+="</div>"},a.prototype.execute=function(a){var b=a.data("editor-command");document.execCommand(b)},a.prototype.getTemplateAfter=function(){return""},a.prototype.addEvents=function(){},a.prototype.getName=function(){return"basic"},window.nekland.Editor.modules.push(a)}(),function(){var a=function(a){this.translator=a};a.prototype.getTemplateBefore=function(){var a='<div class="btn-group">';return a+='<a class="btn btn-default dropdown-toggle link-modal" data-toggle="dropdown" href="#">'+this.translator.translate("link",{ucfirst:!0})+'<span class="caret"></span></a>',a+='<ul class="dropdown-menu">',a+='<li><a href="#" class="open-link-modal">'+this.translator.translate("insertLink",{ucfirst:!0})+"</a></li>",a+='<li><a href="#" class="nekland-editor-command" data-editor-command="unlink" data-editor-module="link" data-prevent="no">'+this.translator.translate("removeLink",{ucfirst:!0})+"</a></li>",a+="</ul></div>"},a.prototype.getTemplateAfter=function(){var a='<div class="modal fade nekland-editor-link" id="link-modal" role="dialog" aria-hidden="true">';return a+='<div class="modal-dialog"><div class="modal-content"><div class="modal-header">',a+='<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>',a+="<h3>"+this.translator.translate("addLink",{ucfirst:!0})+"</h3>",a+="</div>",a+='<div class="modal-body">',a+='<input type="text" class="link-input form-control" id="link-input" style="width: 250px;" />',a+='<p class="error link-error"></p>',a+="</div>",a+='<div class="modal-footer">',a+='<button type="button" class="btn" data-dismiss="modal" aria-hidden="true">',a+=this.translator.translate("close",{ucfirst:!0})+"</button>",a+='<button type="button" class="btn btn-primary nekland-editor-command" data-dismiss="modal" data-editor-module="link" data-editor-command="createLink">',a+=this.translator.translate("insertLink",{ucfirst:!0})+"</button>",a+="</div></div></div></div>"},a.prototype.addEvents=function(){this.$wrapper.find(".open-link-modal").click($.proxy(function(){this.saveSelection(),$("#link-modal").modal("show")},this)),this.$wrapper.find(".link-input").keydown(this.removeEnter)},a.prototype.execute=function(a){var b,c=a.data("editor-command"),d=$("#link-modal"),e=null,f=!1;if("createLink"===c){if(e=$("#link-input").val(),!/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(e))return d.find(".link-error").html(this.translator.translate("notALink",{ucfirst:!0})),f;f=!0}else if("unlink"===c&&(b=this.getCurrentNode(),"A"===b.tagName))return $(b).replaceWith($(b).text()),this.synchronize(),f;return this.replaceSelection(),document.execCommand(c,!1,e),f},a.prototype.getName=function(){return"link"},window.nekland.Editor.modules.push(a)}();